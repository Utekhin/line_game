<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Game - AI vs Human (Gap Registry)</title>
    <style>
:root {
  --cell-size: 40px;
  --board-padding: 20px;
  --x-color: #2196F3;  /* Change from #6c7b7f to blue */
  --o-color: #4CAF50;  /* Change from #708b75 to green */
  --path-planned: rgba(33, 150, 243, 0.3);
  --path-current: rgba(255, 152, 0, 0.5);
  --path-completed: rgba(76, 175, 80, 0.4);
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  background-color: #f5f7fa;
  color: #333;
}

h1 {
  text-align: center;
  color: #2c3e50;
  margin-bottom: 10px;
}

.game-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
  min-height: 100vh; /* STABILITY FIX */
}

.board-section {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  flex-shrink: 0; /* STABILITY FIX */
  min-height: 500px; /* STABILITY FIX */
}

.board-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 15px;
  align-items: center;
}

.status-container {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.status-item {
  background-color: #f8f9fa;
  padding: 10px 15px;
  border-radius: 8px;
  min-width: 100px;
}

.status-item .label {
  font-size: 0.9em;
  color: #7f8c8d;
  margin-bottom: 5px;
}

.status-item .value {
  font-weight: bold;
  font-size: 1.2em;
}

.current-player-x .value {
  color: var(--x-color);
}

.current-player-o .value {
  color: var(--o-color);
}

/* ENHANCED BOARD CONTAINER - Stability Fixes */
.board-container {
  position: relative;
  width: 100%;
  margin: 0 auto;
  max-width: min(80vw, 70vh);
  aspect-ratio: 1/1;
  
  /* STABILITY FIXES */
  min-width: 400px;
  min-height: 400px;
  max-height: 80vh;
  box-sizing: border-box;
  overflow: visible;
  contain: layout style;
}

/* ENHANCED BOARD GRID - Stability Fixes */
.board-grid {
  display: grid;
  grid-template-columns: repeat(15, 1fr);
  grid-template-rows: repeat(15, 1fr); /* STABILITY FIX */
  gap: 1px;
  background-color: #ddd;
  border: 2px solid #34495e;
  border-radius: 4px;
  overflow: visible; /* STABILITY FIX */
  
  /* LOCK DIMENSIONS */
  width: 100% !important;
  height: 100% !important;
  min-width: 400px;
  min-height: 400px;
  box-sizing: border-box;
}

.cell {
  aspect-ratio: 1/1;
  background-color: white;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.2s;
  
  /* STABILITY FIXES */
  min-width: 20px;
  min-height: 20px;
  box-sizing: border-box;
  overflow: visible;
}

.cell.x {
  background-color: rgba(108, 123, 127, 0.1);
}

.cell.o {
  background-color: rgba(112, 139, 117, 0.1);
}

/* Hover effects for human turns */
.cell.hover-valid {
  background-color: rgba(112, 139, 117, 0.3) !important;
  border: 2px dashed #708b75;
  box-sizing: border-box; /* STABILITY FIX */
}

.cell.hover-invalid {
  background-color: rgba(255, 0, 0, 0.2) !important;
  border: 2px dashed #ff0000;
  box-sizing: border-box; /* STABILITY FIX */
}

.cell-number {
  position: absolute;
  top: 2px;
  left: 2px;
  font-size: 0.6em;
  color: #bbb;
}

.move-text {
  font-weight: bold;
  font-size: 1.2em;
  z-index: 2;
}

.x .move-text {
  color: var(--x-color);
}

.o .move-text {
  color: var(--o-color);
}

.last-move {
  animation: pulse 1s infinite alternate;
  border: 3px solid #ff9800 !important;
  transform-origin: center; /* STABILITY FIX */
  will-change: transform; /* STABILITY FIX */
  isolation: isolate; /* STABILITY FIX */
}

.path-planned {
  background-color: var(--path-planned) !important;
  border: 2px dashed #2196F3;
  box-sizing: border-box; /* STABILITY FIX */
}

.path-current {
  background-color: var(--path-current) !important;
  border: 3px solid #FF9800;
  animation: pulse 1s infinite alternate;
  box-sizing: border-box; /* STABILITY FIX */
}

.path-completed {
  background-color: var(--path-completed) !important;
  border: 2px solid #4CAF50;
  box-sizing: border-box; /* STABILITY FIX */
}

.path-border {
    background-color: rgba(255, 193, 7, 0.6) !important;
    border: 3px solid #FFC107 !important;
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
    box-sizing: border-box; /* STABILITY FIX */
}

.gap-candidate {
    background-color: rgba(255, 193, 7, 0.4) !important;
    border: 2px dashed #FFC107 !important;
    box-sizing: border-box; /* STABILITY FIX */
}

@keyframes pulse {
  0% { transform: scale(1); }
  100% { transform: scale(1.05); }
}

/* STABILIZED SVG OVERLAYS */
#diagonal-lines-svg,
#path-overlay {
  position: absolute !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  pointer-events: none;
  z-index: 5;
  overflow: visible;
  max-width: none !important;
  max-height: none !important;
}

#path-overlay {
  z-index: 10;
}

/* STABILITY CLASSES */
.board-container.urgent-update {
  transform: none !important;
  scale: none !important;
  zoom: 1 !important;
}

.board-container.layout-reset {
  width: 100% !important;
  height: auto !important;
  aspect-ratio: 1/1 !important;
  transform: none !important;
  scale: 1 !important;
  zoom: 1 !important;
}

.board-container.emergency-mode {
  outline: 3px solid #ff6b6b;
  outline-offset: -3px;
}

.controls-section {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.controls-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
}

button {
  padding: 12px 24px;
  border: none;
  border-radius: 5px;
  background-color: #3498db;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.2s;
  font-size: 1.1em;
  min-width: 150px;
}

button:hover {
  background-color: #2980b9;
}

button:disabled {
  background-color: #bdc3c7;
  cursor: not-allowed;
}

#mainButton {
  background-color: #2ecc71;
}

#mainButton:hover {
  background-color: #27ae60;
}

#mainButton.new-game {
  background-color: #e74c3c;
}

#mainButton.new-game:hover {
  background-color: #c0392b;
}

/* Debug buttons */
.debug-controls {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #eee;
}

.debug-button {
  background-color: #95a5a6;
  min-width: 120px;
  font-size: 0.9em;
  padding: 8px 16px;
}

.debug-button:hover {
  background-color: #7f8c8d;
}

.turn-section {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  text-align: center;
}

.turn-indicator {
  font-size: 1.3em;
  font-weight: bold;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 10px;
}

.turn-indicator.ai-turn {
  background-color: rgba(108, 123, 127, 0.1);
  color: var(--x-color);
  border: 2px solid var(--x-color);
}

.turn-indicator.human-turn {
  background-color: rgba(112, 139, 117, 0.1);
  color: var(--o-color);
  border: 2px solid var(--o-color);
  animation: pulse 2s infinite alternate;
}

.human-message {
  display: none;
  background-color: rgba(112, 139, 117, 0.2);
  color: var(--o-color);
  padding: 10px;
  border-radius: 5px;
  font-weight: bold;
  margin-top: 10px;
}

.human-message.visible {
  display: block;
  animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
  0% { opacity: 0; transform: translateY(-10px); }
  100% { opacity: 1; transform: translateY(0); }
}

.log-section {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  max-height: 300px;
  overflow-y: auto;
}

.log-header {
  margin-bottom: 15px;
}

.log-entry {
  padding: 10px;
  border-bottom: 1px solid #eee;
  font-family: monospace;
  white-space: pre-wrap;
}

.log-entry:last-child {
  border-bottom: none;
}

#gameLog {
  font-family: monospace;
  white-space: pre-wrap;
  background-color: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  min-height: 100px;
  max-height: 200px;
  overflow-y: auto;
}

#gameProgress {
  font-weight: bold;
  color: #2196F3;
  margin: 10px 0;
}

.value.game-ai-turn {
  color: var(--x-color);
}

.value.game-waiting-human {
  color: var(--o-color);
  animation: pulse 2s infinite alternate;
}

.value.game-paused {
  color: #f39c12;
}

.value.game-over {
  color: #e74c3c;
}

/* Responsive design */
@media (max-width: 768px) {
  .board-container {
    max-width: 95vw;
    max-height: 95vw;
    min-width: 300px;
    min-height: 300px;
  }
  
  .board-grid {
    min-width: 300px;
    min-height: 300px;
  }
  
  .status-container {
    flex-direction: column;
    gap: 10px;
  }
  
  .controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  button {
    min-width: 150px;
  }
  
  .turn-indicator {
    font-size: 1.1em;
  }
}

/* Diagonal line animations with stability fixes */
@keyframes dash {
  0% { stroke-dashoffset: 0; }
  100% { stroke-dashoffset: 10; }
}

.diagonal-line {
  pointer-events: none;
  vector-effect: non-scaling-stroke; /* STABILITY FIX */
}

.diagonal-line-x {
  stroke: var(--x-color) !important;
}

.diagonal-line-o {
  stroke: var(--o-color) !important;
}

.diagonal-main-diagonal {
  stroke-dasharray: 3,2;
}

.diagonal-anti-diagonal {
  stroke-dasharray: 4,1;
}
</style>
</head>
<body>
    <h1>Connection Game - AI vs Human (Gap Registry)</h1>
    
    <div class="game-container">
        
        <!-- Game Board -->
        <div class="board-section">
            <div class="board-header">
                <h2>Game Board</h2>
                <div class="status-container">
                    <div class="status-item">
                        <div class="label">CURRENT PLAYER</div>
                        <div id="currentPlayer" class="value current-player-x">X (AI)</div>
                    </div>
                    <div class="status-item">
                        <div class="label">MOVE COUNT</div>
                        <div id="moveCount" class="value">0</div>
                    </div>
                    <div class="status-item">
                        <div class="label">STATUS</div>
                        <div id="gameStatus" class="value">Ready</div>
                    </div>
                </div>
            </div>
            
            <div class="board-container">
                <div class="board-grid" id="gameBoard"></div>
                <svg id="diagonal-lines-svg"></svg>
                <svg id="path-overlay"></svg>
            </div>
        </div>
        
        <!-- Game Controls -->
        <div class="controls-section">
            <div class="controls-header">
                <h2>Game Controls</h2>
                <div id="gameProgress">AI vs Human - Click Start to Begin</div>
            </div>
            
            <div class="controls">
                <button id="mainButton">Start Game</button>
            </div>
            
            <!-- Debug Controls -->
            <div class="debug-controls">
                <button id="resetLayoutButton" class="debug-button">Reset Layout</button>
                <button id="checkStabilityButton" class="debug-button">Check Stability</button>
                <button id="debugButton" class="debug-button">Debug State</button>
            </div>
        </div>
        
        <!-- Game Log -->
        <div class="log-section">
            <div class="log-header">
                <h2>Game Log</h2>
            </div>
            <div id="gameLog"></div>
        </div>
    </div>
    <!-- Personality Selection Panel -->
<div class="personality-section">
    <h3>AI Personalities</h3>
    
    <div class="player-config">
        <div class="player-x-config">
            <label>Player X (Vertical):</label>
            <select id="personalityX">
                <option value="aggressive_attacker">Aggressive Attacker</option>
                <option value="defensive_builder">Defensive Builder</option>
                <option value="chaotic_experimenter">Chaotic Experimenter</option>
            </select>
        </div>
        
        <div class="player-o-config">
            <label>Player O (Horizontal):</label>
            <select id="personalityO">
                <option value="aggressive_attacker">Aggressive Attacker</option>
                <option value="defensive_builder" selected>Defensive Builder</option>
                <option value="chaotic_experimenter">Chaotic Experimenter</option>
            </select>
        </div>
    </div>
    
    <div class="personality-details">
        <div id="personalityDescription"></div>
        <button id="customizePersonality">Customize Personality</button>
    </div>
</div>

<!-- 1. CORE GAME ENGINE (Foundation) -->
<script src="/js/ai-vs-h-game-core.js"></script>

<!-- 2. NEW UNIFIED MODULES (Must load before anything that uses them) -->
<script src="/js/pattern-detector.js"></script>  
<script src="/js/chain-fragment-analyzer.js"></script>    
<script src="/js/gap-blocking-detector.js"></script>
<script src="/js/gap-analyzer.js"></script>         <!-- NEW: Unified gap analysis -->

<!-- 3. GAME CONFIGURATION -->
<script src="/js/direction-config.js"></script>

<!-- 4. CHAIN MANAGEMENT -->
<script src="/js/chain-head-manager.js"></script>

<!-- 5. UPDATED SYSTEMS (Now use unified modules) -->
<script src="/js/gap-registry.js"></script>         <!-- UPDATED: Uses PatternDetector -->
<script src="/js/simple-chain.js"></script>         <!-- UPDATED: Uses PatternDetector + GapAnalyzer -->

<!-- 6. VISUALIZATION SYSTEM -->
<script src="/js/game-diagonal-lines.js"></script>

<!-- 7. GAME CONTROL LAYER -->
<script src="/js/ai-vs-human-controller.js"></script>
<script src="/js/ai-vs-human-observer.js"></script>

<!-- 8. ACTIVATION SYSTEM (Must load last) -->
<script src="/js/ai-vs-human-activation.js"></script>
<script>
// ===== BOARD STABILITY MANAGER (Keep as-is since it works) =====
class BoardStabilityManager {
    constructor() {
        this.boardContainer = null;
        this.boardGrid = null;
        this.originalDimensions = null;
        this.initialize();
    }

    initialize() {
        this.boardContainer = document.querySelector('.board-container');
        this.boardGrid = document.querySelector('.board-grid');
        
        if (!this.boardContainer || !this.boardGrid) {
            console.warn('Board elements not found - stability manager disabled');
            return;
        }

        this.captureOriginalDimensions();
        this.setupStabilityMonitoring();
        console.log('‚úÖ Board Stability Manager initialized');
    }

    captureOriginalDimensions() {
        setTimeout(() => {
            const containerRect = this.boardContainer.getBoundingClientRect();
            this.originalDimensions = {
                width: containerRect.width,
                height: containerRect.height,
                aspectRatio: containerRect.width / containerRect.height
            };
            console.log('üìê Original dimensions captured:', this.originalDimensions);
        }, 500);
    }

    setupStabilityMonitoring() {
        setInterval(() => this.checkBoardStability(), 2000);
    }

    checkBoardStability(force = false) {
        if (!this.boardContainer || !this.originalDimensions) return;

        const currentRect = this.boardContainer.getBoundingClientRect();
        const containerAspectRatio = currentRect.width / currentRect.height;
        const expectedAspectRatio = this.originalDimensions.aspectRatio;
        
        const aspectRatioDiff = Math.abs(containerAspectRatio - expectedAspectRatio);
        const dimensionChange = Math.abs(currentRect.width - this.originalDimensions.width) / this.originalDimensions.width;
        
        const isUnstable = aspectRatioDiff > 0.1 || 
                          dimensionChange > 0.3 || 
                          currentRect.width < 200 || 
                          currentRect.height < 200;

        if (isUnstable || force) {
            console.warn('üîß Board instability detected - applying fixes');
            this.applyStabilityFixes();
        }
    }

    applyStabilityFixes() {
        console.log('üõ†Ô∏è Applying board stability fixes...');

        // Reset container
        this.boardContainer.style.transform = '';
        this.boardContainer.style.scale = '';
        this.boardContainer.style.zoom = '';
        this.boardContainer.style.width = '100%';
        this.boardContainer.style.height = 'auto';
        this.boardContainer.style.aspectRatio = '1/1';

        // Reset grid
        this.boardGrid.style.width = '100%';
        this.boardGrid.style.height = '100%';
        this.boardGrid.style.display = 'grid';
        this.boardGrid.style.gridTemplateColumns = 'repeat(15, 1fr)';
        this.boardGrid.style.gridTemplateRows = 'repeat(15, 1fr)';

        // Reset SVG overlays (only diagonal lines now)
        const svgElements = [
            document.getElementById('diagonal-lines-svg')
        ].filter(Boolean);
        
        svgElements.forEach(svg => {
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
        });

        // Force layout recalculation
        setTimeout(() => {
            const temp = this.boardContainer.offsetHeight;
            this.boardContainer.style.display = 'none';
            this.boardContainer.offsetHeight;
            this.boardContainer.style.display = '';
            console.log('‚úÖ Stability fixes applied');
        }, 100);
    }

    resetBoardLayout() {
        console.log('üîß Manual board layout reset');
        this.applyStabilityFixes();
        setTimeout(() => this.captureOriginalDimensions(), 500);
    }
}

// ===== UPDATED INITIALIZATION FOR GAP REGISTRY =====
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ HTML: Gap Registry initialization starting...');
    
    // Initialize board stability manager
    window.boardStabilityManager = new BoardStabilityManager();
    
    // Global helper functions for board stability
    window.resetBoardLayout = () => {
        if (window.boardStabilityManager) {
            window.boardStabilityManager.resetBoardLayout();
        }
    };

    window.checkBoardStability = () => {
        if (window.boardStabilityManager) {
            window.boardStabilityManager.checkBoardStability(true);
        }
    };
    
    // UPDATED: Global helpers for gap registry system
    window.debugChainHeads = () => {
        if (window.aivsHumanInstance?.controller?.ai?.chainHeadManager) {
            window.aivsHumanInstance.controller.ai.chainHeadManager.analyzeChainStructure();
        } else {
            console.log('‚ùå Chain head manager not available');
        }
    };
    
    window.showAIStats = () => {
        if (window.aivsHumanInstance?.controller?.ai) {
            const stats = window.aivsHumanInstance.controller.ai.getStats();
            console.log('üìä AI Statistics:', stats);
        } else {
            console.log('‚ùå AI not available');
        }
    };
    
    // NEW: Gap registry specific helpers
    window.debugGapRegistry = () => {
        if (window.aivsHumanInstance?.controller?.ai?.gapRegistry) {
            window.aivsHumanInstance.controller.ai.gapRegistry.debugGapDetection();
        } else {
            console.log('‚ùå Gap registry not available');
        }
    };
    
    window.getGapStats = () => {
        if (window.aivsHumanInstance?.controller?.ai?.gapRegistry) {
            const stats = window.aivsHumanInstance.controller.ai.gapRegistry.getStats();
            console.log('üìä Gap Registry Stats:', stats);
            return stats;
        } else {
            console.log('‚ùå Gap registry not available');
            return null;
        }
    };
    
    console.log('‚úÖ HTML: Gap Registry initialization complete');
    console.log('üîß Available debug commands:');
    console.log('  - debugChainHeads() - Analyze chain head structure');
    console.log('  - showAIStats() - Show AI statistics');
    console.log('  - debugGapRegistry() - Debug gap registry specifically');
    console.log('  - getGapStats() - Get gap registry statistics');
    console.log('  - resetBoardLayout() - Reset board layout');
    console.log('  - checkBoardStability() - Check board stability');
    
    // The ai-vs-human-activation.js will handle the rest
});

console.log('‚úÖ HTML: Gap Registry initialization script loaded');
</script>
</body>
</html>